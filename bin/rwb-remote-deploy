#!/bin/bash -eu

RWB_SCRIPT_DIR=$(dirname $0)
. $RWB_SCRIPT_DIR/rwb-functions

# This sets the package- and deployment-specific env vars
. ./rwb-package-config.env

if [ $# -ne 1 ]; then
    echo "Error: Expected usage: $0 <local-build-name>" 1>&2
    echo "Here, <local-build-name> should be an entry in the local '$RWB_LOCAL_BUILDS_DIR' directory (it can be a symlink or regular directory).  Easiest local build name is 'latest-build'." 1>&2
    exit 1
fi

PACKAGE_NAME=$(cargo_package_name)

BUILD_NAME=$1
RWB_CRATE_BUILD_DIR=$RWB_LOCAL_BUILDS_DIR/$PACKAGE_NAME
BUILD_PATH=$RWB_CRATE_BUILD_DIR/$BUILD_NAME
REAL_BUILD_PATH=$(realpath $BUILD_PATH)
REAL_BUILD_NAME=$(basename $REAL_BUILD_PATH)

if [ ! -d "$REAL_BUILD_PATH" ]; then
    echo "Error: Can't deploy build '$BUILD_NAME'; expected path '$REAL_BUILD_PATH' to exist and be a directory -- aborting." 1>&2
    exit 1
fi

REMOTE_WB_CRATE_BUILD_DIR=$RWB_REMOTE_BUILDS_DIR/$PACKAGE_NAME
REMOTE_BUILD_PATH=$REMOTE_WB_CRATE_BUILD_DIR/$REAL_BUILD_NAME

echo "Attempting to deploy LOCAL build '$REAL_BUILD_NAME' via ssh to '$RWB_REMOTE_SSH_HOST' ..." 1>&2

# Ensure the builds dir exists.
ssh $RWB_REMOTE_SSH_HOST mkdir -p $REMOTE_WB_CRATE_BUILD_DIR

echo "Checking if REMOTE build '$REAL_BUILD_NAME' already exists on '$RWB_REMOTE_SSH_HOST' ..." 1>&2

# If the build doesn't exist, scp it into place.  Note that in bash scripts, `test` considers 0 to be true,
# so REMOTE_BUILD_EXISTS=0 means that the remote build DOES exist.
REMOTE_BUILD_EXISTS=$(ssh $RWB_REMOTE_SSH_HOST ls $REMOTE_BUILD_PATH &>/dev/null; echo $?)
if [ $REMOTE_BUILD_EXISTS -eq 0 ]; then
    echo "REMOTE build '$REAL_BUILD_NAME' already exists on '$RWB_REMOTE_SSH_HOST'." 1>&2
else
    echo "Copying LOCAL build '$REAL_BUILD_NAME' via ssh to '$RWB_REMOTE_SSH_HOST' ..." 1>&2
    scp -r $REAL_BUILD_PATH $RWB_REMOTE_SSH_HOST:$REMOTE_BUILD_PATH
    # Just verify that it exists now.
    ssh $RWB_REMOTE_SSH_HOST ls $REMOTE_BUILD_PATH &>/dev/null
fi

echo "REMOTE build '$REAL_BUILD_NAME' has been deployed to '$RWB_REMOTE_SSH_HOST'." 1>&2
